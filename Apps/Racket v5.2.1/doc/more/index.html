<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><head><meta http-equiv="content-type" content="text-html; charset=utf-8" /><title>More: Systems Programming with Racket</title><link rel="stylesheet" type="text/css" href="../scribble.css" title="default" /><link rel="stylesheet" type="text/css" href="../racket.css" title="default" /><link rel="stylesheet" type="text/css" href="../scribble-style.css" title="default" /><script type="text/javascript" src="../scribble-common.js"></script></head><body id="doc-racket-lang-org"><div class="tocset"><div class="tocview"><div class="tocviewlist" style="margin-bottom: 1em;"><div class="tocviewtitle"><table cellspacing="0" cellpadding="0"><tr><td style="width: 1em;"><a href="javascript:void(0);" title="Expand/Collapse" class="tocviewtoggle" onclick="TocviewToggle(this,&quot;tocview_0&quot;);">&#9658;</a></td><td></td><td><a href="" class="tocviewselflink" pltdoc="x">More:<span class="mywbr"> </span> Systems Programming with Racket</a></td></tr></table></div><div class="tocviewsublistonly" style="display: none;" id="tocview_0"><table cellspacing="0" cellpadding="0"><tr><td align="right">1&nbsp;</td><td><a href="#(part._.Ready___)" class="tocviewlink" pltdoc="x">Ready...</a></td></tr><tr><td align="right">2&nbsp;</td><td><a href="#(part._.Set___)" class="tocviewlink" pltdoc="x">Set...</a></td></tr><tr><td align="right">3&nbsp;</td><td><a href="#(part._.Go_)" class="tocviewlink" pltdoc="x">Go!</a></td></tr><tr><td align="right">4&nbsp;</td><td><a href="#(part.__.Hello_.World__.Server)" class="tocviewlink" pltdoc="x">&ldquo;Hello World&rdquo; Server</a></td></tr><tr><td align="right">5&nbsp;</td><td><a href="#(part._.Server_.Thread)" class="tocviewlink" pltdoc="x">Server Thread</a></td></tr><tr><td align="right">6&nbsp;</td><td><a href="#(part._.Connection_.Threads)" class="tocviewlink" pltdoc="x">Connection Threads</a></td></tr><tr><td align="right">7&nbsp;</td><td><a href="#(part._.Terminating_.Connections)" class="tocviewlink" pltdoc="x">Terminating Connections</a></td></tr><tr><td align="right">8&nbsp;</td><td><a href="#(part._.Dispatching)" class="tocviewlink" pltdoc="x">Dispatching</a></td></tr><tr><td align="right">9&nbsp;</td><td><a href="#(part._.Servlets_and_.Sessions)" class="tocviewlink" pltdoc="x">Servlets and Sessions</a></td></tr><tr><td align="right">10&nbsp;</td><td><a href="#(part._.Limiting_.Memory_.Use)" class="tocviewlink" pltdoc="x">Limiting Memory Use</a></td></tr><tr><td align="right">11&nbsp;</td><td><a href="#(part._.Continuations)" class="tocviewlink" pltdoc="x">Continuations</a></td></tr><tr><td align="right">12&nbsp;</td><td><a href="#(part._.Where_to_.Go_.From_.Here)" class="tocviewlink" pltdoc="x">Where to Go From Here</a></td></tr><tr><td align="right"></td><td><a href="#(part._doc-bibliography)" class="tocviewlink" pltdoc="x">Bibliography</a></td></tr></table></div></div></div><div class="tocsub"><table class="tocsublist" cellspacing="0"><tr><td><span class="tocsublinknumber">1<tt>&nbsp;</tt></span><a href="#(part._.Ready___)" class="tocsubseclink" pltdoc="x">Ready...</a></td></tr><tr><td><span class="tocsublinknumber">2<tt>&nbsp;</tt></span><a href="#(part._.Set___)" class="tocsubseclink" pltdoc="x">Set...</a></td></tr><tr><td><span class="tocsublinknumber">3<tt>&nbsp;</tt></span><a href="#(part._.Go_)" class="tocsubseclink" pltdoc="x">Go!</a></td></tr><tr><td><span class="tocsublinknumber">4<tt>&nbsp;</tt></span><a href="#(part.__.Hello_.World__.Server)" class="tocsubseclink" pltdoc="x">&ldquo;Hello World&rdquo; Server</a></td></tr><tr><td><span class="tocsublinknumber">5<tt>&nbsp;</tt></span><a href="#(part._.Server_.Thread)" class="tocsubseclink" pltdoc="x">Server Thread</a></td></tr><tr><td><span class="tocsublinknumber">6<tt>&nbsp;</tt></span><a href="#(part._.Connection_.Threads)" class="tocsubseclink" pltdoc="x">Connection Threads</a></td></tr><tr><td><span class="tocsublinknumber">7<tt>&nbsp;</tt></span><a href="#(part._.Terminating_.Connections)" class="tocsubseclink" pltdoc="x">Terminating Connections</a></td></tr><tr><td><span class="tocsublinknumber">8<tt>&nbsp;</tt></span><a href="#(part._.Dispatching)" class="tocsubseclink" pltdoc="x">Dispatching</a></td></tr><tr><td><span class="tocsublinknumber">9<tt>&nbsp;</tt></span><a href="#(part._.Servlets_and_.Sessions)" class="tocsubseclink" pltdoc="x">Servlets and Sessions</a></td></tr><tr><td><span class="tocsublinknumber">10<tt>&nbsp;</tt></span><a href="#(part._.Limiting_.Memory_.Use)" class="tocsubseclink" pltdoc="x">Limiting Memory Use</a></td></tr><tr><td><span class="tocsublinknumber">11<tt>&nbsp;</tt></span><a href="#(part._.Continuations)" class="tocsubseclink" pltdoc="x">Continuations</a></td></tr><tr><td><span class="tocsublinknumber">12<tt>&nbsp;</tt></span><a href="#(part._.Where_to_.Go_.From_.Here)" class="tocsubseclink" pltdoc="x">Where to Go From Here</a></td></tr><tr><td><span class="tocsublinknumber"></span><a href="#(part._doc-bibliography)" class="tocsubseclink" pltdoc="x">Bibliography</a></td></tr></table></div></div><div class="maincolumn"><div class="main"><div class="versionbox"><span class="version">Version: 5.2.1</span></div><div class="navsettop"><span class="navleft"><form class="searchform"><input class="searchbox" style="color: #888;" type="text" value="...search manuals..." title="Enter a search string to search the manuals" onkeypress="return DoSearchKey(event, this, &quot;5.2.1&quot;, &quot;../&quot;);" onfocus="this.style.color=&quot;black&quot;; this.style.textAlign=&quot;left&quot;; if (this.value == &quot;...search manuals...&quot;) this.value=&quot;&quot;;" onblur="if (this.value.match(/^ *$/)) { this.style.color=&quot;#888&quot;; this.style.textAlign=&quot;center&quot;; this.value=&quot;...search manuals...&quot;; }" /></form>&nbsp;&nbsp;<a href="../index.html" title="up to the documentation top" pltdoc="x" onclick="return GotoPLTRoot(&quot;5.2.1&quot;);">top</a></span><span class="navright"><span class="nonavigation">&larr; prev</span>&nbsp;&nbsp;<a href="../index.html" title="up to the documentation top" pltdoc="x" onclick="return GotoPLTRoot(&quot;5.2.1&quot;);">up</a>&nbsp;&nbsp;<span class="nonavigation">next &rarr;</span></span>&nbsp;</div><h2><a name="(part._top)"></a><a name="(part._.More__.Systems_.Programming_with_.Racket)"></a>More: Systems Programming with Racket</h2><div class="SAuthorListBox"><span class="SAuthorList"><p class="author">Matthew Flatt</p></span></div><p>In contrast to the impression that <a href="../quick/index.html" pltdoc="x">Quick: An Introduction to Racket with Pictures</a> may give, Racket is
not just another pretty face. Underneath the graphical facade of
DrRacket lies a sophisticated toolbox for managing threads and
processes, which is the subject of this tutorial.</p><p>Specifically, we show how to build a secure, multi-threaded,
servlet-extensible, continuation-based web server. We use much more of
the language than in <a href="../quick/index.html" pltdoc="x">Quick: An Introduction to Racket with Pictures</a>, and we expect you to click on syntax or
function names that you don&rsquo;t recognize (which will take you to the
relevant documentation). Beware that the last couple of sections
present material that is normally considered difficult. If you&rsquo;re
still new to Racket and have relatively little programming experience,
you may want to skip to <a href="../guide/index.html" pltdoc="x"><span style="font-weight: bold">The Racket Guide</span></a>.</p><p>To get into the spirit of this tutorial, we suggest that you set
DrRacket aside for a moment, and switch to raw <span class="stt">racket</span> in a
terminal. You&rsquo;ll also need a text editor, such as Emacs, vi, or even
Notepad&#8212;<wbr></wbr>any editor will do, but one that supports parenthesis
matching would be helpful. Finally, you&rsquo;ll need a web client, perhaps
Lynx or Firefox.</p><blockquote class="refpara"><blockquote class="refcolumn"><blockquote class="refcontent"><p>Of course, if you&rsquo;re already spoiled, you can keep using
DrRacket.</p></blockquote></blockquote></blockquote><h3>1<tt>&nbsp;</tt><a name="(part._.Ready___)"></a>Ready...</h3><p><a href="http://racket-lang.org/">Download Racket</a>, install, and then
start <span class="stt">racket</span> with no command-line arguments:</p><p><table cellspacing="0"><tr><td><p><span class="stt"><span class="hspace">&nbsp;&nbsp;</span><span class="stt">$ racket</span></span></p></td></tr><tr><td><p><span class="stt"><span class="hspace">&nbsp;&nbsp;</span><span class="stt">Welcome to Racket v5.2.1.</span></span></p></td></tr><tr><td><p><span class="stt"><span class="hspace">&nbsp;&nbsp;</span><span class="stt">&gt;</span></span></p></td></tr></table></p><p>For extra read-eval-print loop support, evaluate <span class="RktPn">(</span><span class="RktSym"><a href="../reference/require.html#(form._((lib._racket/private/base..rkt)._require))" class="RktStxLink" pltdoc="x">require</a></span><span class="stt"> </span><a href="../xrepl/index.html" class="RktModLink" pltdoc="x"><span class="RktSym">xrepl</span></a><span class="RktPn">)</span>
to enable Readline-based input&#8212;<wbr></wbr>assuming that you have GNU Readline
installed on your system&#8212;<wbr></wbr>and comma-prefixed meta-commands that
support exploration and development. To have <a href="../xrepl/index.html" class="RktModLink" pltdoc="x"><span class="RktSym">xrepl</span></a>
loaded by default, use the <a href="../xrepl/index.html#(xrepl._install!)" class="plainlink" pltdoc="x"><span class="RktInBG"><span class="hspace"></span><span class="RktIn">,install!</span><span class="hspace"></span></span></a> command, which updates
your <span class="stt">"~/.racketrc"</span> to load <a href="../xrepl/index.html" class="RktModLink" pltdoc="x"><span class="RktSym">xrepl</span></a> whenever you
start <span class="stt">racket</span> for interactive evaluation.</p><blockquote class="refpara"><blockquote class="refcolumn"><blockquote class="refcontent"><p>Unfortunately, for legal reasons related to GPL vs. LGPL,
<span class="stt">racket</span> cannot provide Readline automatically.</p></blockquote></blockquote></blockquote><blockquote class="SCodeFlow"><table cellspacing="0" class="RktBlk"><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/require.html#(form._((lib._racket/private/base..rkt)._require))" class="RktStxLink" pltdoc="x">require</a></span><span class="stt"> </span><a href="../xrepl/index.html" class="RktModLink" pltdoc="x"><span class="RktSym">xrepl</span></a><span class="RktPn">)</span></td></tr><tr><td><table cellspacing="0"><tr><td></td></tr></table></td></tr><tr><td><span class="stt">&gt; </span><a href="../xrepl/index.html#(xrepl._install!)" class="plainlink" pltdoc="x"><span class="RktInBG"><span class="hspace"></span><span class="RktIn">,install!</span><span class="hspace"></span></span></a></td></tr><tr><td><table cellspacing="0"><tr><td></td></tr></table></td></tr></table></blockquote><p>If you want <span style="font-style: italic">just</span> readline support in <span class="stt">racket</span>, evaluate
<span class="RktPn">(</span><span class="RktSym"><a href="../reference/require.html#(form._((lib._racket/private/base..rkt)._require))" class="RktStxLink" pltdoc="x">require</a></span><span class="stt"> </span><a href="../readline/index.html#(mod-path._readline)" class="RktModLink" pltdoc="x"><span class="RktSym">readline</span></a><span class="RktPn">)</span>, instead, and then use <span class="RktPn">(</span><span class="RktSym"><a href="../readline/index.html#(def._((lib._readline/main..rkt)._install-readline!))" class="RktValLink" pltdoc="x">install-readline!</a></span><span class="RktPn">)</span>  to
adjust <span class="stt">"~/.racketrc"</span> to load <a href="../readline/index.html#(mod-path._readline)" class="RktModLink" pltdoc="x"><span class="RktSym">readline</span></a>.
Readline is not needed if you&rsquo;re using <a href="../xrepl/index.html" class="RktModLink" pltdoc="x"><span class="RktSym">xrepl</span></a>, if
you&rsquo;re running a shell inside Emacs, or if you&rsquo;re on Windows and use a
<span class="stt">cmd</span> window.</p><blockquote class="SCodeFlow"><table cellspacing="0" class="RktBlk"><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/require.html#(form._((lib._racket/private/base..rkt)._require))" class="RktStxLink" pltdoc="x">require</a></span><span class="stt"> </span><a href="../readline/index.html#(mod-path._readline)" class="RktModLink" pltdoc="x"><span class="RktSym">readline</span></a><span class="RktPn">)</span></td></tr><tr><td><table cellspacing="0"><tr><td></td></tr></table></td></tr><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="../readline/index.html#(def._((lib._readline/main..rkt)._install-readline!))" class="RktValLink" pltdoc="x">install-readline!</a></span><span class="RktPn">)</span></td></tr><tr><td><table cellspacing="0"><tr><td></td></tr></table></td></tr></table></blockquote><h3>2<tt>&nbsp;</tt><a name="(part._.Set___)"></a>Set...</h3><p>In the same directory where you started <span class="stt">racket</span>, create a text
file <span class="stt">"serve.rkt"</span>, and start it like this:</p><blockquote class="SCodeFlow"><table cellspacing="0" class="RktBlk"><tr><td><a href="../guide/Module_Syntax.html#(part._hash-lang)" class="RktModLink" pltdoc="x"><span class="RktMod">#lang</span></a><span class="hspace">&nbsp;</span><a href="../reference/index.html" class="RktModLink" pltdoc="x"><span class="RktSym">racket</span></a></td></tr><tr><td><span class="hspace">&nbsp;</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="../reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="RktStxLink" pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">go</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktVal">'</span><span class="RktVal">yep-it-works</span><span class="RktPn">)</span></td></tr></table></blockquote><blockquote class="refpara"><blockquote class="refcolumn"><blockquote class="refcontent"><p>Here&rsquo;s the whole program so far in plain text: <a href="step0.txt">step 0</a>.</p></blockquote></blockquote></blockquote><h3>3<tt>&nbsp;</tt><a name="(part._.Go_)"></a>Go!</h3><p>Back in <span class="stt">racket</span>, try loading the file and running <span class="RktSym">go</span>:</p><blockquote class="refpara"><blockquote class="refcolumn"><blockquote class="refcontent"><p>If you use <a href="../xrepl/index.html" class="RktModLink" pltdoc="x"><span class="RktSym">xrepl</span></a>, you can use
<a href="../xrepl/index.html#(xrepl._enter)" class="plainlink" pltdoc="x"><span class="RktInBG"><span class="hspace"></span><span class="RktIn">,enter serve.rkt</span><span class="hspace"></span></span></a>.</p></blockquote></blockquote></blockquote><blockquote class="SCodeFlow"><table cellspacing="0" class="RktBlk"><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/enter.html#(form._((lib._racket/enter..rkt)._enter!))" class="RktStxLink" pltdoc="x">enter!</a></span><span class="hspace">&nbsp;</span><span class="RktVal">"serve.rkt"</span><span class="RktPn">)</span></td></tr><tr><td><p><span class="RktErr"></span><span class="hspace">&nbsp;</span><span class="RktErr">[loading serve.rkt]</span></p></td></tr><tr><td><table cellspacing="0"><tr><td></td></tr></table></td></tr><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym">go</span><span class="RktPn">)</span></td></tr><tr><td><p><span class="RktRes">'yep-it-works</span></p></td></tr></table></blockquote><p>Try modifying <span class="stt">"serve.rkt"</span>, and then run <span class="RktPn">(</span><span class="RktSym"><a href="../reference/enter.html#(form._((lib._racket/enter..rkt)._enter!))" class="RktStxLink" pltdoc="x">enter!</a></span><span class="stt"> </span><span class="RktVal">"serve.rkt"</span><span class="RktPn">)</span> again to re-load the module, and then check your changes.</p><h3>4<tt>&nbsp;</tt><a name="(part.__.Hello_.World__.Server)"></a>&ldquo;Hello World&rdquo; Server</h3><p>We&rsquo;ll implement the web server through a <span class="RktSym">serve</span> function that
takes an IP port number for client connections:</p><blockquote class="SCodeFlow"><table cellspacing="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="../reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="RktStxLink" pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">serve</span><span class="hspace">&nbsp;</span><span class="RktSym">port-no</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktSym"><a href="../reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="RktStxLink" pltdoc="x">...</a></span><span class="RktPn">)</span></td></tr></table></blockquote><p>The server accepts TCP connections through a <span style="font-style: italic">listener</span>, which
we create with <span class="RktSym"><a href="../reference/tcp.html#(def._((lib._racket/tcp..rkt)._tcp-listen))" class="RktValLink" pltdoc="x">tcp-listen</a></span>. To make interactive development
easier, we supply <span class="RktVal">#t</span> as the third argument to
<span class="RktSym"><a href="../reference/tcp.html#(def._((lib._racket/tcp..rkt)._tcp-listen))" class="RktValLink" pltdoc="x">tcp-listen</a></span>, which lets us re-use the port number immediately,
without waiting for a TCP timeout.</p><blockquote class="SCodeFlow"><table cellspacing="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="../reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="RktStxLink" pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">serve</span><span class="hspace">&nbsp;</span><span class="RktSym">port-no</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="RktStxLink" pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktSym">listener</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/tcp.html#(def._((lib._racket/tcp..rkt)._tcp-listen))" class="RktValLink" pltdoc="x">tcp-listen</a></span><span class="hspace">&nbsp;</span><span class="RktSym">port-no</span><span class="hspace">&nbsp;</span><span class="RktVal">5</span><span class="hspace">&nbsp;</span><span class="RktVal">#t</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktSym"><a href="../reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="RktStxLink" pltdoc="x">...</a></span><span class="RktPn">)</span></td></tr></table></blockquote><p>The server must loop to accept connections from the listener:</p><blockquote class="SCodeFlow"><table cellspacing="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="../reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="RktStxLink" pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">serve</span><span class="hspace">&nbsp;</span><span class="RktSym">port-no</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="RktStxLink" pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktSym">listener</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/tcp.html#(def._((lib._racket/tcp..rkt)._tcp-listen))" class="RktValLink" pltdoc="x">tcp-listen</a></span><span class="hspace">&nbsp;</span><span class="RktSym">port-no</span><span class="hspace">&nbsp;</span><span class="RktVal">5</span><span class="hspace">&nbsp;</span><span class="RktVal">#t</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="RktStxLink" pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">loop</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">accept-and-handle</span><span class="hspace">&nbsp;</span><span class="RktSym">listener</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">loop</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">loop</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote><p>Our <span class="RktSym">accept-and-handle</span> function accepts a connection using
<span class="RktSym"><a href="../reference/tcp.html#(def._((lib._racket/tcp..rkt)._tcp-accept))" class="RktValLink" pltdoc="x">tcp-accept</a></span>, which returns two values: a stream for input from
the client, and a stream for output to the client.</p><blockquote class="SCodeFlow"><table cellspacing="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="../reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="RktStxLink" pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">accept-and-handle</span><span class="hspace">&nbsp;</span><span class="RktSym">listener</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/define.html#(form._((quote._~23~25kernel)._define-values))" class="RktStxLink" pltdoc="x">define-values</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">in</span><span class="hspace">&nbsp;</span><span class="RktSym">out</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/tcp.html#(def._((lib._racket/tcp..rkt)._tcp-accept))" class="RktValLink" pltdoc="x">tcp-accept</a></span><span class="hspace">&nbsp;</span><span class="RktSym">listener</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">handle</span><span class="hspace">&nbsp;</span><span class="RktSym">in</span><span class="hspace">&nbsp;</span><span class="RktSym">out</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/port-ops.html#(def._((quote._~23~25kernel)._close-input-port))" class="RktValLink" pltdoc="x">close-input-port</a></span><span class="hspace">&nbsp;</span><span class="RktSym">in</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/port-ops.html#(def._((quote._~23~25kernel)._close-output-port))" class="RktValLink" pltdoc="x">close-output-port</a></span><span class="hspace">&nbsp;</span><span class="RktSym">out</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote><p>To handle a connection, for now, we&rsquo;ll read and discard the request
header, and then write a &ldquo;Hello, world!&rdquo; web page as the result:</p><blockquote class="SCodeFlow"><table cellspacing="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="../reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="RktStxLink" pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">handle</span><span class="hspace">&nbsp;</span><span class="RktSym">in</span><span class="hspace">&nbsp;</span><span class="RktSym">out</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktCmt">;</span><span class="RktCmt">&nbsp;</span><span class="RktCmt">Discard the request header (up to blank line):</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/regexp.html#(def._((quote._~23~25kernel)._regexp-match))" class="RktValLink" pltdoc="x">regexp-match</a></span><span class="hspace">&nbsp;</span><span class="RktVal">#rx"(\r\n|^)\r\n"</span><span class="hspace">&nbsp;</span><span class="RktSym">in</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktCmt">;</span><span class="RktCmt">&nbsp;</span><span class="RktCmt">Send reply:</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/Writing.html#(def._((quote._~23~25kernel)._display))" class="RktValLink" pltdoc="x">display</a></span><span class="hspace">&nbsp;</span><span class="RktVal">"HTTP/1.0 200 Okay\r\n"</span><span class="hspace">&nbsp;</span><span class="RktSym">out</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/Writing.html#(def._((quote._~23~25kernel)._display))" class="RktValLink" pltdoc="x">display</a></span><span class="hspace">&nbsp;</span><span class="RktVal">"Server: k\r\nContent-Type: text/html\r\n\r\n"</span><span class="hspace">&nbsp;</span><span class="RktSym">out</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/Writing.html#(def._((quote._~23~25kernel)._display))" class="RktValLink" pltdoc="x">display</a></span><span class="hspace">&nbsp;</span><span class="RktVal">"&lt;html&gt;&lt;body&gt;Hello, world!&lt;/body&gt;&lt;/html&gt;"</span><span class="hspace">&nbsp;</span><span class="RktSym">out</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote><p>Note that <span class="RktSym"><a href="../reference/regexp.html#(def._((quote._~23~25kernel)._regexp-match))" class="RktValLink" pltdoc="x">regexp-match</a></span> operates directly on the input stream,
which is easier than bothering with individual lines.</p><blockquote class="refpara"><blockquote class="refcolumn"><blockquote class="refcontent"><p>Here&rsquo;s the whole program so far in plain text: <a href="step1.txt">step 1</a>.</p></blockquote></blockquote></blockquote><p>Copy the above three definitions&#8212;<wbr></wbr><span class="RktSym">serve</span>,
<span class="RktSym">accept-and-handle</span>, and <span class="RktSym">handle</span>&#8212;<wbr></wbr>into
<span class="stt">"serve.rkt"</span> and re-load:</p><blockquote class="SCodeFlow"><table cellspacing="0" class="RktBlk"><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/enter.html#(form._((lib._racket/enter..rkt)._enter!))" class="RktStxLink" pltdoc="x">enter!</a></span><span class="hspace">&nbsp;</span><span class="RktVal">"serve.rkt"</span><span class="RktPn">)</span></td></tr><tr><td><p><span class="RktErr"></span><span class="hspace">&nbsp;</span><span class="RktErr">[re-loading serve.rkt]</span></p></td></tr><tr><td><table cellspacing="0"><tr><td></td></tr></table></td></tr><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym">serve</span><span class="hspace">&nbsp;</span><span class="RktVal">8080</span><span class="RktPn">)</span></td></tr><tr><td><table cellspacing="0"><tr><td></td></tr></table></td></tr></table></blockquote><p>Now point your browser to <span class="stt">http://localhost:8080</span> (assuming that
you used <span class="RktVal">8080</span> as the port number, and that the browser is
running on the same machine) to receive a friendly greeting from your
web server.</p><h3>5<tt>&nbsp;</tt><a name="(part._.Server_.Thread)"></a>Server Thread</h3><p>Before we can make the web server respond in more interesting ways, we
need to get a Racket prompt back. Typing Ctl-C in your terminal window
interrupts the server loop:</p><blockquote class="refpara"><blockquote class="refcolumn"><blockquote class="refcontent"><p>In DrRacket, instead of typing Ctl-C, click the
<span style="font-family: sans-serif; font-size: 80%; font-weight: bold">Stop</span> button once.</p></blockquote></blockquote></blockquote><blockquote class="SCodeFlow"><table cellspacing="0" class="RktBlk"><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym">serve</span><span class="hspace">&nbsp;</span><span class="RktVal">8080</span><span class="RktPn">)</span></td></tr><tr><td><p><span class="RktErr">^Cuser break</span></p></td></tr><tr><td><table cellspacing="0"><tr><td></td></tr></table></td></tr><tr><td><span class="stt">&gt; </span></td></tr><tr><td><table cellspacing="0"><tr><td></td></tr></table></td></tr></table></blockquote><p>Unfortunately, we cannot now re-start the server with the same port
number:</p><blockquote class="SCodeFlow"><table cellspacing="0" class="RktBlk"><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym">serve</span><span class="hspace">&nbsp;</span><span class="RktVal">8080</span><span class="RktPn">)</span></td></tr><tr><td><p><span class="RktErr">tcp-listen: listen on 8080 failed (address already in use)</span></p></td></tr></table></blockquote><p>The problem is that the listener that we created with <span class="RktSym">serve</span>
is still listening on the original port number.</p><p>To avoid this problem, let&rsquo;s put the listener loop in its own thread,
and have <span class="RktSym">serve</span> return immediately. Furthermore, we&rsquo;ll have
<span class="RktSym">serve</span> return a function that can be used to shut down the
server thread and TCP listener:</p><blockquote class="SCodeFlow"><table cellspacing="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="../reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="RktStxLink" pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">serve</span><span class="hspace">&nbsp;</span><span class="RktSym">port-no</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="RktStxLink" pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktSym">listener</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/tcp.html#(def._((lib._racket/tcp..rkt)._tcp-listen))" class="RktValLink" pltdoc="x">tcp-listen</a></span><span class="hspace">&nbsp;</span><span class="RktSym">port-no</span><span class="hspace">&nbsp;</span><span class="RktVal">5</span><span class="hspace">&nbsp;</span><span class="RktVal">#t</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="RktStxLink" pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">loop</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">accept-and-handle</span><span class="hspace">&nbsp;</span><span class="RktSym">listener</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">loop</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="RktStxLink" pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktSym">t</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/threads.html#(def._((quote._~23~25kernel)._thread))" class="RktValLink" pltdoc="x">thread</a></span><span class="hspace">&nbsp;</span><span class="RktSym">loop</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/lambda.html#(form._((lib._racket/private/base..rkt)._lambda))" class="RktStxLink" pltdoc="x">lambda</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/threads.html#(def._((quote._~23~25kernel)._kill-thread))" class="RktValLink" pltdoc="x">kill-thread</a></span><span class="hspace">&nbsp;</span><span class="RktSym">t</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/tcp.html#(def._((lib._racket/tcp..rkt)._tcp-close))" class="RktValLink" pltdoc="x">tcp-close</a></span><span class="hspace">&nbsp;</span><span class="RktSym">listener</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote><blockquote class="refpara"><blockquote class="refcolumn"><blockquote class="refcontent"><p>Here&rsquo;s the whole program so far in plain text: <a href="step2.txt">step 2</a>.</p></blockquote></blockquote></blockquote><p>Try the new one:</p><blockquote class="SCodeFlow"><table cellspacing="0" class="RktBlk"><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/enter.html#(form._((lib._racket/enter..rkt)._enter!))" class="RktStxLink" pltdoc="x">enter!</a></span><span class="hspace">&nbsp;</span><span class="RktVal">"serve.rkt"</span><span class="RktPn">)</span></td></tr><tr><td><p><span class="RktErr"></span><span class="hspace">&nbsp;</span><span class="RktErr">[re-loading serve.rkt]</span></p></td></tr><tr><td><table cellspacing="0"><tr><td></td></tr></table></td></tr><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="RktStxLink" pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktSym">stop</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">serve</span><span class="hspace">&nbsp;</span><span class="RktVal">8081</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><table cellspacing="0"><tr><td></td></tr></table></td></tr></table></blockquote><p>Your server should now respond to <span class="stt">http://localhost:8081</span>, but you
can shut down and restart the server on the same port number as often
as you like:</p><blockquote class="SCodeFlow"><table cellspacing="0" class="RktBlk"><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym">stop</span><span class="RktPn">)</span></td></tr><tr><td><table cellspacing="0"><tr><td></td></tr></table></td></tr><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="RktStxLink" pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktSym">stop</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">serve</span><span class="hspace">&nbsp;</span><span class="RktVal">8081</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><table cellspacing="0"><tr><td></td></tr></table></td></tr><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym">stop</span><span class="RktPn">)</span></td></tr><tr><td><table cellspacing="0"><tr><td></td></tr></table></td></tr><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="RktStxLink" pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktSym">stop</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">serve</span><span class="hspace">&nbsp;</span><span class="RktVal">8081</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><table cellspacing="0"><tr><td></td></tr></table></td></tr><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym">stop</span><span class="RktPn">)</span></td></tr><tr><td><table cellspacing="0"><tr><td></td></tr></table></td></tr></table></blockquote><h3>6<tt>&nbsp;</tt><a name="(part._.Connection_.Threads)"></a>Connection Threads</h3><p>In the same way that we put the main server loop into a background
thread, we can put each individual connection into its own thread:</p><blockquote class="SCodeFlow"><table cellspacing="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="../reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="RktStxLink" pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">accept-and-handle</span><span class="hspace">&nbsp;</span><span class="RktSym">listener</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/define.html#(form._((quote._~23~25kernel)._define-values))" class="RktStxLink" pltdoc="x">define-values</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">in</span><span class="hspace">&nbsp;</span><span class="RktSym">out</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/tcp.html#(def._((lib._racket/tcp..rkt)._tcp-accept))" class="RktValLink" pltdoc="x">tcp-accept</a></span><span class="hspace">&nbsp;</span><span class="RktSym">listener</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/threads.html#(def._((quote._~23~25kernel)._thread))" class="RktValLink" pltdoc="x">thread</a></span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/lambda.html#(form._((lib._racket/private/base..rkt)._lambda))" class="RktStxLink" pltdoc="x">lambda</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">handle</span><span class="hspace">&nbsp;</span><span class="RktSym">in</span><span class="hspace">&nbsp;</span><span class="RktSym">out</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/port-ops.html#(def._((quote._~23~25kernel)._close-input-port))" class="RktValLink" pltdoc="x">close-input-port</a></span><span class="hspace">&nbsp;</span><span class="RktSym">in</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/port-ops.html#(def._((quote._~23~25kernel)._close-output-port))" class="RktValLink" pltdoc="x">close-output-port</a></span><span class="hspace">&nbsp;</span><span class="RktSym">out</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote><blockquote class="refpara"><blockquote class="refcolumn"><blockquote class="refcontent"><p>Here&rsquo;s the whole program so far in plain text: <a href="step3.txt">step 3</a>.</p></blockquote></blockquote></blockquote><p>With this change, our server can now handle multiple threads at
once. The handler is so fast that this fact will be difficult to
detect, however, so try inserting <span class="RktPn">(</span><span class="RktSym"><a href="../reference/threads.html#(def._((quote._~23~25kernel)._sleep))" class="RktValLink" pltdoc="x">sleep</a></span><span class="stt"> </span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/generic-numbers.html#(def._((quote._~23~25kernel)._random))" class="RktValLink" pltdoc="x">random</a></span><span class="stt"> </span><span class="RktVal">10</span><span class="RktPn">)</span><span class="RktPn">)</span> before
the <span class="RktSym">handle</span> call above. If you make multiple connections from
the web browser at roughly the same time, some will return soon, and
some will take up to 10 seconds. The random delays will be independent
of the order in which you started the connections.</p><h3>7<tt>&nbsp;</tt><a name="(part._.Terminating_.Connections)"></a>Terminating Connections</h3><p>A malicious client could connect to our web server and not send the
HTTP header, in which case a connection thread will idle forever,
waiting for the end of the header. To avoid this possibility, we&rsquo;d
like to implement a timeout for each connection thread.</p><p>One way to implement the timeout is to create a second thread that
waits for 10 seconds, and then kills the thread that calls
<span class="RktSym">handle</span>. Threads are lightweight enough in Racket that this
watcher-thread strategy works well:</p><blockquote class="SCodeFlow"><table cellspacing="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="../reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="RktStxLink" pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">accept-and-handle</span><span class="hspace">&nbsp;</span><span class="RktSym">listener</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/define.html#(form._((quote._~23~25kernel)._define-values))" class="RktStxLink" pltdoc="x">define-values</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">in</span><span class="hspace">&nbsp;</span><span class="RktSym">out</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/tcp.html#(def._((lib._racket/tcp..rkt)._tcp-accept))" class="RktValLink" pltdoc="x">tcp-accept</a></span><span class="hspace">&nbsp;</span><span class="RktSym">listener</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="RktStxLink" pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktSym">t</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/threads.html#(def._((quote._~23~25kernel)._thread))" class="RktValLink" pltdoc="x">thread</a></span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/lambda.html#(form._((lib._racket/private/base..rkt)._lambda))" class="RktStxLink" pltdoc="x">lambda</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">handle</span><span class="hspace">&nbsp;</span><span class="RktSym">in</span><span class="hspace">&nbsp;</span><span class="RktSym">out</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/port-ops.html#(def._((quote._~23~25kernel)._close-input-port))" class="RktValLink" pltdoc="x">close-input-port</a></span><span class="hspace">&nbsp;</span><span class="RktSym">in</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/port-ops.html#(def._((quote._~23~25kernel)._close-output-port))" class="RktValLink" pltdoc="x">close-output-port</a></span><span class="hspace">&nbsp;</span><span class="RktSym">out</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktCmt">;</span><span class="RktCmt">&nbsp;</span><span class="RktCmt">Watcher thread:</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/threads.html#(def._((quote._~23~25kernel)._thread))" class="RktValLink" pltdoc="x">thread</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/lambda.html#(form._((lib._racket/private/base..rkt)._lambda))" class="RktStxLink" pltdoc="x">lambda</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/threads.html#(def._((quote._~23~25kernel)._sleep))" class="RktValLink" pltdoc="x">sleep</a></span><span class="hspace">&nbsp;</span><span class="RktVal">10</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/threads.html#(def._((quote._~23~25kernel)._kill-thread))" class="RktValLink" pltdoc="x">kill-thread</a></span><span class="hspace">&nbsp;</span><span class="RktSym">t</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote><p>This first attempt isn&rsquo;t quite right, because when the thread is
killed, its <span class="RktSym">in</span> and <span class="RktSym">out</span> streams remain open.  We
could add code to the watcher thread to close the streams as well as
kill the thread, but Racket offers a more general shutdown mechanism:
<span style="font-style: italic">custodians</span>. A custodian is a kind of container for all
resources other than memory, and it supports a
<span class="RktSym"><a href="../reference/custodians.html#(def._((quote._~23~25kernel)._custodian-shutdown-all))" class="RktValLink" pltdoc="x">custodian-shutdown-all</a></span> operation that terminates and closes
all resources within the container, whether they&rsquo;re threads, streams,
or other kinds of limited resources.</p><p>Whenever a thread or stream is created, it is placed into the current
custodian as determined by the <span class="RktSym"><a href="../reference/custodians.html#(def._((quote._~23~25kernel)._current-custodian))" class="RktValLink" pltdoc="x">current-custodian</a></span>
parameter. To place everything about a connection into a custodian, we
<span class="RktSym"><a href="../reference/parameters.html#(form._((lib._racket/private/more-scheme..rkt)._parameterize))" class="RktStxLink" pltdoc="x">parameterize</a></span> all the resource creations to go into a new
custodian:</p><blockquote class="refpara"><blockquote class="refcolumn"><blockquote class="refcontent"><p>See <a href="../guide/parameterize.html" pltdoc="x">Dynamic Binding: <span class="RktSym"><span class="RktStxLink">parameterize</span></span></a>
for an introduction to parameters.</p></blockquote></blockquote></blockquote><blockquote class="SCodeFlow"><table cellspacing="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="../reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="RktStxLink" pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">accept-and-handle</span><span class="hspace">&nbsp;</span><span class="RktSym">listener</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="RktStxLink" pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktSym">cust</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/custodians.html#(def._((quote._~23~25kernel)._make-custodian))" class="RktValLink" pltdoc="x">make-custodian</a></span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/parameters.html#(form._((lib._racket/private/more-scheme..rkt)._parameterize))" class="RktStxLink" pltdoc="x">parameterize</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktPn">[</span><span class="RktSym"><a href="../reference/custodians.html#(def._((quote._~23~25kernel)._current-custodian))" class="RktValLink" pltdoc="x">current-custodian</a></span><span class="hspace">&nbsp;</span><span class="RktSym">cust</span><span class="RktPn">]</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/define.html#(form._((quote._~23~25kernel)._define-values))" class="RktStxLink" pltdoc="x">define-values</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">in</span><span class="hspace">&nbsp;</span><span class="RktSym">out</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/tcp.html#(def._((lib._racket/tcp..rkt)._tcp-accept))" class="RktValLink" pltdoc="x">tcp-accept</a></span><span class="hspace">&nbsp;</span><span class="RktSym">listener</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/threads.html#(def._((quote._~23~25kernel)._thread))" class="RktValLink" pltdoc="x">thread</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/lambda.html#(form._((lib._racket/private/base..rkt)._lambda))" class="RktStxLink" pltdoc="x">lambda</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">handle</span><span class="hspace">&nbsp;</span><span class="RktSym">in</span><span class="hspace">&nbsp;</span><span class="RktSym">out</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/port-ops.html#(def._((quote._~23~25kernel)._close-input-port))" class="RktValLink" pltdoc="x">close-input-port</a></span><span class="hspace">&nbsp;</span><span class="RktSym">in</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/port-ops.html#(def._((quote._~23~25kernel)._close-output-port))" class="RktValLink" pltdoc="x">close-output-port</a></span><span class="hspace">&nbsp;</span><span class="RktSym">out</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktCmt">;</span><span class="RktCmt">&nbsp;</span><span class="RktCmt">Watcher thread:</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/threads.html#(def._((quote._~23~25kernel)._thread))" class="RktValLink" pltdoc="x">thread</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/lambda.html#(form._((lib._racket/private/base..rkt)._lambda))" class="RktStxLink" pltdoc="x">lambda</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/threads.html#(def._((quote._~23~25kernel)._sleep))" class="RktValLink" pltdoc="x">sleep</a></span><span class="hspace">&nbsp;</span><span class="RktVal">10</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/custodians.html#(def._((quote._~23~25kernel)._custodian-shutdown-all))" class="RktValLink" pltdoc="x">custodian-shutdown-all</a></span><span class="hspace">&nbsp;</span><span class="RktSym">cust</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote><p>With this implementation, <span class="RktSym">in</span>, <span class="RktSym">out</span>, and the thread
that calls <span class="RktSym">handle</span> all belong to <span class="RktSym">cust</span>. In addition,
if we later change <span class="RktSym">handle</span> so that it, say, opens a file, then
the file handles will also belong to <span class="RktSym">cust</span>, so they will be
reliably closed when <span class="RktSym">cust</span> is shut down.</p><p>In fact, it&rsquo;s a good idea to change <span class="RktSym">serve</span> so that it uses a
custodian, too:</p><blockquote class="SCodeFlow"><table cellspacing="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="../reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="RktStxLink" pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">serve</span><span class="hspace">&nbsp;</span><span class="RktSym">port-no</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="RktStxLink" pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktSym">main-cust</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/custodians.html#(def._((quote._~23~25kernel)._make-custodian))" class="RktValLink" pltdoc="x">make-custodian</a></span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/parameters.html#(form._((lib._racket/private/more-scheme..rkt)._parameterize))" class="RktStxLink" pltdoc="x">parameterize</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktPn">[</span><span class="RktSym"><a href="../reference/custodians.html#(def._((quote._~23~25kernel)._current-custodian))" class="RktValLink" pltdoc="x">current-custodian</a></span><span class="hspace">&nbsp;</span><span class="RktSym">main-cust</span><span class="RktPn">]</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="RktStxLink" pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktSym">listener</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/tcp.html#(def._((lib._racket/tcp..rkt)._tcp-listen))" class="RktValLink" pltdoc="x">tcp-listen</a></span><span class="hspace">&nbsp;</span><span class="RktSym">port-no</span><span class="hspace">&nbsp;</span><span class="RktVal">5</span><span class="hspace">&nbsp;</span><span class="RktVal">#t</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="RktStxLink" pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">loop</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">accept-and-handle</span><span class="hspace">&nbsp;</span><span class="RktSym">listener</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">loop</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/threads.html#(def._((quote._~23~25kernel)._thread))" class="RktValLink" pltdoc="x">thread</a></span><span class="hspace">&nbsp;</span><span class="RktSym">loop</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/lambda.html#(form._((lib._racket/private/base..rkt)._lambda))" class="RktStxLink" pltdoc="x">lambda</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/custodians.html#(def._((quote._~23~25kernel)._custodian-shutdown-all))" class="RktValLink" pltdoc="x">custodian-shutdown-all</a></span><span class="hspace">&nbsp;</span><span class="RktSym">main-cust</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote><p>That way, the <span class="RktSym">main-cust</span> created in <span class="RktSym">serve</span> not only
owns the TCP listener and the main server thread, it also owns every
custodian created for a connection. Consequently, the revised shutdown
procedure for the server immediately terminates all active connections,
in addition to the main server loop.</p><blockquote class="refpara"><blockquote class="refcolumn"><blockquote class="refcontent"><p>Here&rsquo;s the whole program so far in plain text: <a href="step4.txt">step 4</a>.</p></blockquote></blockquote></blockquote><p>After updating the <span class="RktSym">serve</span> and <span class="RktSym">accept-and-handle</span>
functions as above, here&rsquo;s how you can simulate a malicious client:</p><blockquote class="SCodeFlow"><table cellspacing="0" class="RktBlk"><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/enter.html#(form._((lib._racket/enter..rkt)._enter!))" class="RktStxLink" pltdoc="x">enter!</a></span><span class="hspace">&nbsp;</span><span class="RktVal">"serve.rkt"</span><span class="RktPn">)</span></td></tr><tr><td><p><span class="RktErr"></span><span class="hspace">&nbsp;</span><span class="RktErr">[re-loading serve.rkt]</span></p></td></tr><tr><td><table cellspacing="0"><tr><td></td></tr></table></td></tr><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="RktStxLink" pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktSym">stop</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">serve</span><span class="hspace">&nbsp;</span><span class="RktVal">8081</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><table cellspacing="0"><tr><td></td></tr></table></td></tr><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/define.html#(form._((quote._~23~25kernel)._define-values))" class="RktStxLink" pltdoc="x">define-values</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">cin</span><span class="hspace">&nbsp;</span><span class="RktSym">cout</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/tcp.html#(def._((lib._racket/tcp..rkt)._tcp-connect))" class="RktValLink" pltdoc="x">tcp-connect</a></span><span class="hspace">&nbsp;</span><span class="RktVal">"localhost"</span><span class="hspace">&nbsp;</span><span class="RktVal">8081</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><table cellspacing="0"><tr><td></td></tr></table></td></tr></table></blockquote><p>Now wait 10 seconds. If you try reading from <span class="RktSym">cin</span>, which is
the stream that sends data from the server back to the client, you&rsquo;ll
find that the server has shut down the connection:</p><blockquote class="SCodeFlow"><table cellspacing="0" class="RktBlk"><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/Byte_and_String_Input.html#(def._((quote._~23~25kernel)._read-line))" class="RktValLink" pltdoc="x">read-line</a></span><span class="hspace">&nbsp;</span><span class="RktSym">cin</span><span class="RktPn">)</span></td></tr><tr><td><p><span class="RktRes">#&lt;eof&gt;</span></p></td></tr></table></blockquote><p>Alternatively, you don&rsquo;t have to wait 10 seconds if you explicitly
shut down the server:</p><blockquote class="SCodeFlow"><table cellspacing="0" class="RktBlk"><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/define.html#(form._((quote._~23~25kernel)._define-values))" class="RktStxLink" pltdoc="x">define-values</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">cin2</span><span class="hspace">&nbsp;</span><span class="RktSym">cout2</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/tcp.html#(def._((lib._racket/tcp..rkt)._tcp-connect))" class="RktValLink" pltdoc="x">tcp-connect</a></span><span class="hspace">&nbsp;</span><span class="RktVal">"localhost"</span><span class="hspace">&nbsp;</span><span class="RktVal">8081</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><table cellspacing="0"><tr><td></td></tr></table></td></tr><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym">stop</span><span class="RktPn">)</span></td></tr><tr><td><table cellspacing="0"><tr><td></td></tr></table></td></tr><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/Byte_and_String_Input.html#(def._((quote._~23~25kernel)._read-line))" class="RktValLink" pltdoc="x">read-line</a></span><span class="hspace">&nbsp;</span><span class="RktSym">cin2</span><span class="RktPn">)</span></td></tr><tr><td><p><span class="RktRes">#&lt;eof&gt;</span></p></td></tr></table></blockquote><h3>8<tt>&nbsp;</tt><a name="(part._.Dispatching)"></a>Dispatching</h3><p>It&rsquo;s finally time to generalize our server&rsquo;s &ldquo;Hello, World!&rdquo;
response to something more useful. Let&rsquo;s adjust the server so that we
can plug in dispatching functions to handle requests to different
URLs.</p><p>To parse the incoming URL and to more easily format HTML output, we&rsquo;ll
require two extra libraries:</p><blockquote class="SCodeFlow"><p><span class="RktPn">(</span><span class="RktSym"><a href="../reference/require.html#(form._((lib._racket/private/base..rkt)._require))" class="RktStxLink" pltdoc="x">require</a></span><span class="hspace">&nbsp;</span><span class="RktSym">xml</span><span class="hspace">&nbsp;</span><span class="RktSym">net/url</span><span class="RktPn">)</span></p></blockquote><p>The <a href="../xml/index.html" class="RktModLink" pltdoc="x"><span class="RktSym">xml</span></a> library gives us <span class="RktSym"><a href="../xml/index.html#(def._((lib._xml/main..rkt)._xexpr-~3estring))" class="RktValLink" pltdoc="x">xexpr-&gt;string</a></span>, which
takes a Racket value that looks like HTML and turns it into actual
HTML:</p><blockquote class="SCodeFlow"><table cellspacing="0" class="RktBlk"><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="../xml/index.html#(def._((lib._xml/main..rkt)._xexpr-~3estring))" class="RktValLink" pltdoc="x">xexpr-&gt;string</a></span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">(</span><span class="RktVal">html</span><span class="hspace">&nbsp;</span><span class="RktVal">(</span><span class="RktVal">head</span><span class="hspace">&nbsp;</span><span class="RktVal">(</span><span class="RktVal">title</span><span class="hspace">&nbsp;</span><span class="RktVal">"Hello"</span><span class="RktVal">)</span><span class="RktVal">)</span><span class="hspace">&nbsp;</span><span class="RktVal">(</span><span class="RktVal">body</span><span class="hspace">&nbsp;</span><span class="RktVal">"Hi!"</span><span class="RktVal">)</span><span class="RktVal">)</span><span class="RktPn">)</span></td></tr><tr><td><p><span class="RktRes">"&lt;html&gt;&lt;head&gt;&lt;title&gt;Hello&lt;/title&gt;&lt;/head&gt;&lt;body&gt;Hi!&lt;/body&gt;&lt;/html&gt;"</span></p></td></tr></table></blockquote><p>We&rsquo;ll assume that our new <span class="RktSym">dispatch</span> function (to be written)
takes a requested URL and produces a result value suitable to use with
<span class="RktSym"><a href="../xml/index.html#(def._((lib._xml/main..rkt)._xexpr-~3estring))" class="RktValLink" pltdoc="x">xexpr-&gt;string</a></span> to send back to the client:</p><blockquote class="SCodeFlow"><table cellspacing="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="../reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="RktStxLink" pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">handle</span><span class="hspace">&nbsp;</span><span class="RktSym">in</span><span class="hspace">&nbsp;</span><span class="RktSym">out</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="RktStxLink" pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktSym">req</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktCmt">;</span><span class="RktCmt">&nbsp;</span><span class="RktCmt">Match the first line to extract the request:</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/regexp.html#(def._((quote._~23~25kernel)._regexp-match))" class="RktValLink" pltdoc="x">regexp-match</a></span><span class="hspace">&nbsp;</span><span class="RktVal">#rx"^GET (.+) HTTP/[0-9]+\\.[0-9]+"</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/Byte_and_String_Input.html#(def._((quote._~23~25kernel)._read-line))" class="RktValLink" pltdoc="x">read-line</a></span><span class="hspace">&nbsp;</span><span class="RktSym">in</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/when_unless.html#(form._((lib._racket/private/letstx-scheme..rkt)._when))" class="RktStxLink" pltdoc="x">when</a></span><span class="hspace">&nbsp;</span><span class="RktSym">req</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktCmt">;</span><span class="RktCmt">&nbsp;</span><span class="RktCmt">Discard the rest of the header (up to blank line):</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/regexp.html#(def._((quote._~23~25kernel)._regexp-match))" class="RktValLink" pltdoc="x">regexp-match</a></span><span class="hspace">&nbsp;</span><span class="RktVal">#rx"(\r\n|^)\r\n"</span><span class="hspace">&nbsp;</span><span class="RktSym">in</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktCmt">;</span><span class="RktCmt">&nbsp;</span><span class="RktCmt">Dispatch:</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/let.html#(form._((lib._racket/private/letstx-scheme..rkt)._let))" class="RktStxLink" pltdoc="x">let</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktPn">[</span><span class="RktSym">xexpr</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">dispatch</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/pairs.html#(def._((quote._~23~25kernel)._list-ref))" class="RktValLink" pltdoc="x">list-ref</a></span><span class="hspace">&nbsp;</span><span class="RktSym">req</span><span class="hspace">&nbsp;</span><span class="RktVal">1</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">]</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktCmt">;</span><span class="RktCmt">&nbsp;</span><span class="RktCmt">Send reply:</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/Writing.html#(def._((quote._~23~25kernel)._display))" class="RktValLink" pltdoc="x">display</a></span><span class="hspace">&nbsp;</span><span class="RktVal">"HTTP/1.0 200 Okay\r\n"</span><span class="hspace">&nbsp;</span><span class="RktSym">out</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/Writing.html#(def._((quote._~23~25kernel)._display))" class="RktValLink" pltdoc="x">display</a></span><span class="hspace">&nbsp;</span><span class="RktVal">"Server: k\r\nContent-Type: text/html\r\n\r\n"</span><span class="hspace">&nbsp;</span><span class="RktSym">out</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/Writing.html#(def._((quote._~23~25kernel)._display))" class="RktValLink" pltdoc="x">display</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../xml/index.html#(def._((lib._xml/main..rkt)._xexpr-~3estring))" class="RktValLink" pltdoc="x">xexpr-&gt;string</a></span><span class="hspace">&nbsp;</span><span class="RktSym">xexpr</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktSym">out</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote><p>The <a href="../net/url.html" class="RktModLink" pltdoc="x"><span class="RktSym">net/url</span></a> library gives us <span class="RktSym"><a href="../net/url.html#(def._((lib._net/url..rkt)._string-~3eurl))" class="RktValLink" pltdoc="x">string-&gt;url</a></span>,
<span class="RktSym"><a href="../net/url.html#(def._((lib._net/url-structs..rkt)._url-path))" class="RktValLink" pltdoc="x">url-path</a></span>, <span class="RktSym"><a href="../net/url.html#(def._((lib._net/url-structs..rkt)._path/param-path))" class="RktValLink" pltdoc="x">path/param-path</a></span>, and <span class="RktSym"><a href="../net/url.html#(def._((lib._net/url-structs..rkt)._url-query))" class="RktValLink" pltdoc="x">url-query</a></span>
for getting from a string to parts of the URL that it represents:</p><blockquote class="SCodeFlow"><table cellspacing="0" class="RktBlk"><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="RktStxLink" pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktSym">u</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../net/url.html#(def._((lib._net/url..rkt)._string-~3eurl))" class="RktValLink" pltdoc="x">string-&gt;url</a></span><span class="hspace">&nbsp;</span><span class="RktVal">"http://localhost:8080/foo/bar?x=bye"</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><table cellspacing="0"><tr><td></td></tr></table></td></tr><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="../net/url.html#(def._((lib._net/url-structs..rkt)._url-path))" class="RktValLink" pltdoc="x">url-path</a></span><span class="hspace">&nbsp;</span><span class="RktSym">u</span><span class="RktPn">)</span></td></tr><tr><td><p><span class="RktRes">'(#&lt;path/param&gt; #&lt;path/param&gt;)</span></p></td></tr><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/pairs.html#(def._((lib._racket/private/map..rkt)._map))" class="RktValLink" pltdoc="x">map</a></span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="../net/url.html#(def._((lib._net/url-structs..rkt)._path/param-path))" class="RktValLink" pltdoc="x">path/param-path</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../net/url.html#(def._((lib._net/url-structs..rkt)._url-path))" class="RktValLink" pltdoc="x">url-path</a></span><span class="hspace">&nbsp;</span><span class="RktSym">u</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><p><span class="RktRes">'("foo" "bar")</span></p></td></tr><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="../net/url.html#(def._((lib._net/url-structs..rkt)._url-query))" class="RktValLink" pltdoc="x">url-query</a></span><span class="hspace">&nbsp;</span><span class="RktSym">u</span><span class="RktPn">)</span></td></tr><tr><td><p><span class="RktRes">'((x . "bye"))</span></p></td></tr></table></blockquote><p>We use these pieces to implement <span class="RktSym">dispatch</span>. The
<span class="RktSym">dispatch</span> function consults a hash table that maps an initial
path element, like <span class="RktVal">"foo"</span>, to a handler function:</p><blockquote class="SCodeFlow"><table cellspacing="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="../reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="RktStxLink" pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">dispatch</span><span class="hspace">&nbsp;</span><span class="RktSym">str-path</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktCmt">;</span><span class="RktCmt">&nbsp;</span><span class="RktCmt">Parse the request as a URL:</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="RktStxLink" pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="../net/url.html#(def._((lib._net/url-structs..rkt)._url))" class="RktValLink" pltdoc="x">url</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../net/url.html#(def._((lib._net/url..rkt)._string-~3eurl))" class="RktValLink" pltdoc="x">string-&gt;url</a></span><span class="hspace">&nbsp;</span><span class="RktSym">str-path</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktCmt">;</span><span class="RktCmt">&nbsp;</span><span class="RktCmt">Extract the path part:</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="RktStxLink" pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktSym">path</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/pairs.html#(def._((lib._racket/private/map..rkt)._map))" class="RktValLink" pltdoc="x">map</a></span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="../net/url.html#(def._((lib._net/url-structs..rkt)._path/param-path))" class="RktValLink" pltdoc="x">path/param-path</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../net/url.html#(def._((lib._net/url-structs..rkt)._url-path))" class="RktValLink" pltdoc="x">url-path</a></span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="../net/url.html#(def._((lib._net/url-structs..rkt)._url))" class="RktValLink" pltdoc="x">url</a></span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktCmt">;</span><span class="RktCmt">&nbsp;</span><span class="RktCmt">Find a handler based on the path</span><span class="RktCmt">'</span><span class="RktCmt">s first element:</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="RktStxLink" pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktSym">h</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/hashtables.html#(def._((quote._~23~25kernel)._hash-ref))" class="RktValLink" pltdoc="x">hash-ref</a></span><span class="hspace">&nbsp;</span><span class="RktSym">dispatch-table</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/pairs.html#(def._((quote._~23~25kernel)._car))" class="RktValLink" pltdoc="x">car</a></span><span class="hspace">&nbsp;</span><span class="RktSym">path</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktVal">#f</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/if.html#(form._((quote._~23~25kernel)._if))" class="RktStxLink" pltdoc="x">if</a></span><span class="hspace">&nbsp;</span><span class="RktSym">h</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktCmt">;</span><span class="RktCmt">&nbsp;</span><span class="RktCmt">Call a handler:</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">h</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../net/url.html#(def._((lib._net/url-structs..rkt)._url-query))" class="RktValLink" pltdoc="x">url-query</a></span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="../net/url.html#(def._((lib._net/url-structs..rkt)._url))" class="RktValLink" pltdoc="x">url</a></span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktCmt">;</span><span class="RktCmt">&nbsp;</span><span class="RktCmt">No handler found:</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktVal">`</span><span class="RktVal">(</span><span class="RktVal">html</span><span class="hspace">&nbsp;</span><span class="RktVal">(</span><span class="RktVal">head</span><span class="hspace">&nbsp;</span><span class="RktVal">(</span><span class="RktVal">title</span><span class="hspace">&nbsp;</span><span class="RktVal">"Error"</span><span class="RktVal">)</span><span class="RktVal">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktVal">(</span><span class="RktVal">body</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktVal">(</span><span class="RktVal">font</span><span class="hspace">&nbsp;</span><span class="RktVal">(</span><span class="RktVal">(</span><span class="RktVal">color</span><span class="hspace">&nbsp;</span><span class="RktVal">"red"</span><span class="RktVal">)</span><span class="RktVal">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktVal">"Unknown page: "</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktRdr">,</span><span class="RktSym">str-path</span><span class="RktVal">)</span><span class="RktVal">)</span><span class="RktVal">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="../reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="RktStxLink" pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktSym">dispatch-table</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/hashtables.html#(def._((quote._~23~25kernel)._make-hash))" class="RktValLink" pltdoc="x">make-hash</a></span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote><p>With the new <span class="RktSym"><a href="../reference/require.html#(form._((lib._racket/private/base..rkt)._require))" class="RktStxLink" pltdoc="x">require</a></span> import and new <span class="RktSym">handle</span>,
<span class="RktSym">dispatch</span>, and <span class="RktSym">dispatch-table</span> definitions, our
&ldquo;Hello World!&rdquo; server has turned into an error server. You don&rsquo;t have
to stop the server to try it out. After modifying <span class="stt">"serve.rkt"</span>
with the new pieces, evaluate <span class="RktPn">(</span><span class="RktSym"><a href="../reference/enter.html#(form._((lib._racket/enter..rkt)._enter!))" class="RktStxLink" pltdoc="x">enter!</a></span><span class="stt"> </span><span class="RktVal">"serve.rkt"</span><span class="RktPn">)</span> and then
try again to connect to the server. The web browser should show an
&ldquo;Unknown page&rdquo; error in red.</p><p>We can register a handler for the <span class="RktVal">"hello"</span> path like this:</p><blockquote class="SCodeFlow"><table cellspacing="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="../reference/hashtables.html#(def._((quote._~23~25kernel)._hash-set!))" class="RktValLink" pltdoc="x">hash-set!</a></span><span class="hspace">&nbsp;</span><span class="RktSym">dispatch-table</span><span class="hspace">&nbsp;</span><span class="RktVal">"hello"</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/lambda.html#(form._((lib._racket/private/base..rkt)._lambda))" class="RktStxLink" pltdoc="x">lambda</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">query</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktVal">`</span><span class="RktVal">(</span><span class="RktVal">html</span><span class="hspace">&nbsp;</span><span class="RktVal">(</span><span class="RktVal">body</span><span class="hspace">&nbsp;</span><span class="RktVal">"Hello, World!"</span><span class="RktVal">)</span><span class="RktVal">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote><blockquote class="refpara"><blockquote class="refcolumn"><blockquote class="refcontent"><p>Here&rsquo;s the whole program so far in plain text: <a href="step5.txt">step 5</a>.</p></blockquote></blockquote></blockquote><p>After adding these lines and evaluating <span class="RktPn">(</span><span class="RktSym"><a href="../reference/enter.html#(form._((lib._racket/enter..rkt)._enter!))" class="RktStxLink" pltdoc="x">enter!</a></span><span class="stt"> </span><span class="RktVal">"serve.rkt"</span><span class="RktPn">)</span>,
opening <span class="stt">http://localhost:8081/hello</span> should produce the old
greeting.</p><h3>9<tt>&nbsp;</tt><a name="(part._.Servlets_and_.Sessions)"></a>Servlets and Sessions</h3><p>Using the <span class="RktSym">query</span> argument that is passed to a handler by
<span class="RktSym">dispatch</span>, a handler can respond to values that a user
supplies through a form.</p><p>The following helper function constructs an HTML form. The
<span class="RktSym">label</span> argument is a string to show the user. The
<span class="RktSym">next-url</span> argument is a destination for the form results. The
<span class="RktSym">hidden</span> argument is a value to propagate through the form as a
hidden field. When the user responds, the <span class="RktVal">"number"</span> field in
the form holds the user&rsquo;s value:</p><blockquote class="SCodeFlow"><table cellspacing="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="../reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="RktStxLink" pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">build-request-page</span><span class="hspace">&nbsp;</span><span class="RktSym">label</span><span class="hspace">&nbsp;</span><span class="RktSym">next-url</span><span class="hspace">&nbsp;</span><span class="RktSym">hidden</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktVal">`</span><span class="RktVal">(</span><span class="RktVal">html</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktVal">(</span><span class="RktVal">head</span><span class="hspace">&nbsp;</span><span class="RktVal">(</span><span class="RktVal">title</span><span class="hspace">&nbsp;</span><span class="RktVal">"Enter a Number to Add"</span><span class="RktVal">)</span><span class="RktVal">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktVal">(</span><span class="RktVal">body</span><span class="hspace">&nbsp;</span><span class="RktVal">(</span><span class="RktVal">[</span><span class="RktVal">bgcolor</span><span class="hspace">&nbsp;</span><span class="RktVal">"white"</span><span class="RktVal">]</span><span class="RktVal">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktVal">(</span><span class="RktVal">form</span><span class="hspace">&nbsp;</span><span class="RktVal">(</span><span class="RktVal">[</span><span class="RktVal">action</span><span class="hspace">&nbsp;</span><span class="RktRdr">,</span><span class="RktSym">next-url</span><span class="RktVal">]</span><span class="hspace">&nbsp;</span><span class="RktVal">[</span><span class="RktVal">method</span><span class="hspace">&nbsp;</span><span class="RktVal">"get"</span><span class="RktVal">]</span><span class="RktVal">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktRdr">,</span><span class="RktSym">label</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktVal">(</span><span class="RktVal">input</span><span class="hspace">&nbsp;</span><span class="RktVal">(</span><span class="RktVal">[</span><span class="RktVal">type</span><span class="hspace">&nbsp;</span><span class="RktVal">"text"</span><span class="RktVal">]</span><span class="hspace">&nbsp;</span><span class="RktVal">[</span><span class="RktVal">name</span><span class="hspace">&nbsp;</span><span class="RktVal">"number"</span><span class="RktVal">]</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktVal">[</span><span class="RktVal">value</span><span class="hspace">&nbsp;</span><span class="RktVal">""</span><span class="RktVal">]</span><span class="RktVal">)</span><span class="RktVal">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktVal">(</span><span class="RktVal">input</span><span class="hspace">&nbsp;</span><span class="RktVal">(</span><span class="RktVal">[</span><span class="RktVal">type</span><span class="hspace">&nbsp;</span><span class="RktVal">"hidden"</span><span class="RktVal">]</span><span class="hspace">&nbsp;</span><span class="RktVal">[</span><span class="RktVal">name</span><span class="hspace">&nbsp;</span><span class="RktVal">"hidden"</span><span class="RktVal">]</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktVal">[</span><span class="RktVal">value</span><span class="hspace">&nbsp;</span><span class="RktRdr">,</span><span class="RktSym">hidden</span><span class="RktVal">]</span><span class="RktVal">)</span><span class="RktVal">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktVal">(</span><span class="RktVal">input</span><span class="hspace">&nbsp;</span><span class="RktVal">(</span><span class="RktVal">[</span><span class="RktVal">type</span><span class="hspace">&nbsp;</span><span class="RktVal">"submit"</span><span class="RktVal">]</span><span class="hspace">&nbsp;</span><span class="RktVal">[</span><span class="RktVal">name</span><span class="hspace">&nbsp;</span><span class="RktVal">"enter"</span><span class="RktVal">]</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktVal">[</span><span class="RktVal">value</span><span class="hspace">&nbsp;</span><span class="RktVal">"Enter"</span><span class="RktVal">]</span><span class="RktVal">)</span><span class="RktVal">)</span><span class="RktVal">)</span><span class="RktVal">)</span><span class="RktVal">)</span><span class="RktPn">)</span></td></tr></table></blockquote><p>Using this helper function, we can create a servlet that generates as
many &ldquo;hello&rdquo;s as a user wants:</p><blockquote class="refpara"><blockquote class="refcolumn"><blockquote class="refcontent"><p>See <a href="../guide/for.html" pltdoc="x">Iterations and Comprehensions</a>
for an introduction to forms like <span class="RktSym"><a href="../reference/for.html#(form._((lib._racket/private/base..rkt)._for/list))" class="RktStxLink" pltdoc="x">for/list</a></span>.</p></blockquote></blockquote></blockquote><blockquote class="SCodeFlow"><table cellspacing="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="../reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="RktStxLink" pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">many</span><span class="hspace">&nbsp;</span><span class="RktSym">query</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">build-request-page</span><span class="hspace">&nbsp;</span><span class="RktVal">"Number of greetings:"</span><span class="hspace">&nbsp;</span><span class="RktVal">"/reply"</span><span class="hspace">&nbsp;</span><span class="RktVal">""</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="../reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="RktStxLink" pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">reply</span><span class="hspace">&nbsp;</span><span class="RktSym">query</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="RktStxLink" pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktSym">n</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/generic-numbers.html#(def._((quote._~23~25kernel)._string-~3enumber))" class="RktValLink" pltdoc="x">string-&gt;number</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/pairs.html#(def._((quote._~23~25kernel)._cdr))" class="RktValLink" pltdoc="x">cdr</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/pairs.html#(def._((lib._racket/private/list..rkt)._assq))" class="RktValLink" pltdoc="x">assq</a></span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">number</span><span class="hspace">&nbsp;</span><span class="RktSym">query</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktVal">`</span><span class="RktVal">(</span><span class="RktVal">html</span><span class="hspace">&nbsp;</span><span class="RktVal">(</span><span class="RktVal">body</span><span class="hspace">&nbsp;</span><span class="RktRdr">,@</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/for.html#(form._((lib._racket/private/base..rkt)._for/list))" class="RktStxLink" pltdoc="x">for/list</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktPn">[</span><span class="RktSym">i</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/sequences.html#(def._((lib._racket/private/base..rkt)._in-range))" class="RktValLink" pltdoc="x">in-range</a></span><span class="hspace">&nbsp;</span><span class="RktSym">n</span><span class="RktPn">)</span><span class="RktPn">]</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktVal">" hello"</span><span class="RktPn">)</span><span class="RktVal">)</span><span class="RktVal">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="../reference/hashtables.html#(def._((quote._~23~25kernel)._hash-set!))" class="RktValLink" pltdoc="x">hash-set!</a></span><span class="hspace">&nbsp;</span><span class="RktSym">dispatch-table</span><span class="hspace">&nbsp;</span><span class="RktVal">"many"</span><span class="hspace">&nbsp;</span><span class="RktSym">many</span><span class="RktPn">)</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="../reference/hashtables.html#(def._((quote._~23~25kernel)._hash-set!))" class="RktValLink" pltdoc="x">hash-set!</a></span><span class="hspace">&nbsp;</span><span class="RktSym">dispatch-table</span><span class="hspace">&nbsp;</span><span class="RktVal">"reply"</span><span class="hspace">&nbsp;</span><span class="RktSym">reply</span><span class="RktPn">)</span></td></tr></table></blockquote><blockquote class="refpara"><blockquote class="refcolumn"><blockquote class="refcontent"><p>Here&rsquo;s the whole program so far in plain text: <a href="step6.txt">step 6</a>.</p></blockquote></blockquote></blockquote><p>As usual, once you have added these to your program, update with
<span class="RktPn">(</span><span class="RktSym"><a href="../reference/enter.html#(form._((lib._racket/enter..rkt)._enter!))" class="RktStxLink" pltdoc="x">enter!</a></span><span class="stt"> </span><span class="RktVal">"serve.rkt"</span><span class="RktPn">)</span>, and then visit
<span class="stt">http://localhost:8081/many</span>. Provide a number, and you&rsquo;ll receive
a new page with that many &ldquo;hello&rdquo;s.</p><h3>10<tt>&nbsp;</tt><a name="(part._.Limiting_.Memory_.Use)"></a>Limiting Memory Use</h3><p>With our latest <span class="RktVal">"many"</span> servlet, we seem to have a new
problem: a malicious client could request so many &ldquo;hello&rdquo;s that the
server runs out of memory. Actually, a malicious client could also
supply an HTTP request whose first line is arbitrarily long.</p><p>The solution to this class of problems is to limit the memory use of a
connection. Inside <span class="RktSym">accept-and-handle</span>, after the definition of
<span class="RktSym">cust</span>, add the line</p><blockquote class="SCodeFlow"><p><span class="RktPn">(</span><span class="RktSym"><a href="../reference/custodians.html#(def._((quote._~23~25kernel)._custodian-limit-memory))" class="RktValLink" pltdoc="x">custodian-limit-memory</a></span><span class="hspace">&nbsp;</span><span class="RktSym">cust</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" class="RktValLink" pltdoc="x">*</a></span><span class="hspace">&nbsp;</span><span class="RktVal">50</span><span class="hspace">&nbsp;</span><span class="RktVal">1024</span><span class="hspace">&nbsp;</span><span class="RktVal">1024</span><span class="RktPn">)</span><span class="RktPn">)</span></p></blockquote><blockquote class="refpara"><blockquote class="refcolumn"><blockquote class="refcontent"><p>Here&rsquo;s the whole program so far in plain text: <a href="step7.txt">step 7</a>.</p></blockquote></blockquote></blockquote><p>We&rsquo;re assuming that 50MB should be plenty for any
servlet. Garbage-collector overhead means that the actual memory use
of the system can be some small multiple of 50 MB. An important
guarantee, however, is that different connections will not be charged
for each other&rsquo;s memory use, so one misbehaving connection will not
interfere with a different one.</p><p>So, with the new line above, and assuming that you have a couple of
hundred megabytes available for the <span class="stt">racket</span> process to use,
you shouldn&rsquo;t be able to crash the web server by requesting a
ridiculously large number of &ldquo;hello&rdquo;s.</p><p>Given the <span class="RktVal">"many"</span> example, it&rsquo;s a small step to a web server
that accepts arbitrary Racket code to execute on the server. In that
case, there are many additional security issues besides limiting
processor time and memory consumption. The
<a href="../reference/Sandboxed_Evaluation.html" class="RktModLink" pltdoc="x"><span class="RktSym">racket/sandbox</span></a> library provides support to managing
all those other issues.</p><h3>11<tt>&nbsp;</tt><a name="(part._.Continuations)"></a>Continuations</h3><p>As a systems example, the problem of implementing a web server exposes
many system and security issues where a programming language can
help. The web-server example also leads to a classic, advanced Racket
topic: <span style="font-style: italic">continuations</span>. In fact, this facet of a web server
needs <span style="font-style: italic">delimited continuations</span>, which Racket provides.</p><p>The problem solved by continuations is related to servlet sessions and
user input, where a computation spans multiple client connections
[<a href="#(cite._.Queinnec00)" pltdoc="x">Queinnec00</a>]. Often, client-side computation (as in AJAX) is the
right solution to the problem, but many problems are best solved with
a mixture of techniques (e.g., to take advantage of the browser&rsquo;s
&ldquo;back&rdquo; button).</p><p>As the multi-connection computation becomes more complex, propagating
arguments through <span class="RktSym">query</span> becomes increasingly tedious. For
example, we can implement a servlet that takes two numbers to add by
using the hidden field in the form to remember the first number:</p><blockquote class="SCodeFlow"><table cellspacing="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="../reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="RktStxLink" pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">sum</span><span class="hspace">&nbsp;</span><span class="RktSym">query</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">build-request-page</span><span class="hspace">&nbsp;</span><span class="RktVal">"First number:"</span><span class="hspace">&nbsp;</span><span class="RktVal">"/one"</span><span class="hspace">&nbsp;</span><span class="RktVal">""</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="../reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="RktStxLink" pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">one</span><span class="hspace">&nbsp;</span><span class="RktSym">query</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">build-request-page</span><span class="hspace">&nbsp;</span><span class="RktVal">"Second number:"</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktVal">"/two"</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/pairs.html#(def._((quote._~23~25kernel)._cdr))" class="RktValLink" pltdoc="x">cdr</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/pairs.html#(def._((lib._racket/private/list..rkt)._assq))" class="RktValLink" pltdoc="x">assq</a></span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">number</span><span class="hspace">&nbsp;</span><span class="RktSym">query</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="../reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="RktStxLink" pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">two</span><span class="hspace">&nbsp;</span><span class="RktSym">query</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/let.html#(form._((lib._racket/private/letstx-scheme..rkt)._let))" class="RktStxLink" pltdoc="x">let</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktPn">[</span><span class="RktSym">n</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/generic-numbers.html#(def._((quote._~23~25kernel)._string-~3enumber))" class="RktValLink" pltdoc="x">string-&gt;number</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/pairs.html#(def._((quote._~23~25kernel)._cdr))" class="RktValLink" pltdoc="x">cdr</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/pairs.html#(def._((lib._racket/private/list..rkt)._assq))" class="RktValLink" pltdoc="x">assq</a></span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">hidden</span><span class="hspace">&nbsp;</span><span class="RktSym">query</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">]</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">[</span><span class="RktSym">m</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/generic-numbers.html#(def._((quote._~23~25kernel)._string-~3enumber))" class="RktValLink" pltdoc="x">string-&gt;number</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/pairs.html#(def._((quote._~23~25kernel)._cdr))" class="RktValLink" pltdoc="x">cdr</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/pairs.html#(def._((lib._racket/private/list..rkt)._assq))" class="RktValLink" pltdoc="x">assq</a></span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">number</span><span class="hspace">&nbsp;</span><span class="RktSym">query</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">]</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktVal">`</span><span class="RktVal">(</span><span class="RktVal">html</span><span class="hspace">&nbsp;</span><span class="RktVal">(</span><span class="RktVal">body</span><span class="hspace">&nbsp;</span><span class="RktVal">"The sum is "</span><span class="hspace">&nbsp;</span><span class="RktRdr">,</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/generic-numbers.html#(def._((quote._~23~25kernel)._number-~3estring))" class="RktValLink" pltdoc="x">number-&gt;string</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="RktValLink" pltdoc="x">+</a></span><span class="hspace">&nbsp;</span><span class="RktSym">m</span><span class="hspace">&nbsp;</span><span class="RktSym">n</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktVal">)</span><span class="RktVal">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="../reference/hashtables.html#(def._((quote._~23~25kernel)._hash-set!))" class="RktValLink" pltdoc="x">hash-set!</a></span><span class="hspace">&nbsp;</span><span class="RktSym">dispatch-table</span><span class="hspace">&nbsp;</span><span class="RktVal">"sum"</span><span class="hspace">&nbsp;</span><span class="RktSym">sum</span><span class="RktPn">)</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="../reference/hashtables.html#(def._((quote._~23~25kernel)._hash-set!))" class="RktValLink" pltdoc="x">hash-set!</a></span><span class="hspace">&nbsp;</span><span class="RktSym">dispatch-table</span><span class="hspace">&nbsp;</span><span class="RktVal">"one"</span><span class="hspace">&nbsp;</span><span class="RktSym">one</span><span class="RktPn">)</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="../reference/hashtables.html#(def._((quote._~23~25kernel)._hash-set!))" class="RktValLink" pltdoc="x">hash-set!</a></span><span class="hspace">&nbsp;</span><span class="RktSym">dispatch-table</span><span class="hspace">&nbsp;</span><span class="RktVal">"two"</span><span class="hspace">&nbsp;</span><span class="RktSym">two</span><span class="RktPn">)</span></td></tr></table></blockquote><blockquote class="refpara"><blockquote class="refcolumn"><blockquote class="refcontent"><p>Here&rsquo;s the whole program so far in plain text: <a href="step8.txt">step 8</a>.</p></blockquote></blockquote></blockquote><p>While the above works, we would much rather write such computations in
a direct style:</p><blockquote class="SCodeFlow"><table cellspacing="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="../reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="RktStxLink" pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">sum2</span><span class="hspace">&nbsp;</span><span class="RktSym">query</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="RktStxLink" pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktSym">m</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">get-number</span><span class="hspace">&nbsp;</span><span class="RktVal">"First number:"</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="RktStxLink" pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktSym">n</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">get-number</span><span class="hspace">&nbsp;</span><span class="RktVal">"Second number:"</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktVal">`</span><span class="RktVal">(</span><span class="RktVal">html</span><span class="hspace">&nbsp;</span><span class="RktVal">(</span><span class="RktVal">body</span><span class="hspace">&nbsp;</span><span class="RktVal">"The sum is "</span><span class="hspace">&nbsp;</span><span class="RktRdr">,</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/generic-numbers.html#(def._((quote._~23~25kernel)._number-~3estring))" class="RktValLink" pltdoc="x">number-&gt;string</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="RktValLink" pltdoc="x">+</a></span><span class="hspace">&nbsp;</span><span class="RktSym">m</span><span class="hspace">&nbsp;</span><span class="RktSym">n</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktVal">)</span><span class="RktVal">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="../reference/hashtables.html#(def._((quote._~23~25kernel)._hash-set!))" class="RktValLink" pltdoc="x">hash-set!</a></span><span class="hspace">&nbsp;</span><span class="RktSym">dispatch-table</span><span class="hspace">&nbsp;</span><span class="RktVal">"sum2"</span><span class="hspace">&nbsp;</span><span class="RktSym">sum2</span><span class="RktPn">)</span></td></tr></table></blockquote><p>The problem is that <span class="RktSym">get-number</span> needs to send an HTML response
back for the current connection, and then it must obtain a response
through a new connection. That is, somehow it needs to convert the
page generated by <span class="RktSym">build-request-page</span> into a <span class="RktSym">query</span>
result:</p><blockquote class="SCodeFlow"><table cellspacing="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="../reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="RktStxLink" pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">get-number</span><span class="hspace">&nbsp;</span><span class="RktSym">label</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="RktStxLink" pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktSym">query</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktSym"><a href="../reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="RktStxLink" pltdoc="x">...</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">build-request-page</span><span class="hspace">&nbsp;</span><span class="RktSym">label</span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="../reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="RktStxLink" pltdoc="x">...</a></span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="../reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="RktStxLink" pltdoc="x">...</a></span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/generic-numbers.html#(def._((quote._~23~25kernel)._number-~3estring))" class="RktValLink" pltdoc="x">number-&gt;string</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/pairs.html#(def._((quote._~23~25kernel)._cdr))" class="RktValLink" pltdoc="x">cdr</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/pairs.html#(def._((lib._racket/private/list..rkt)._assq))" class="RktValLink" pltdoc="x">assq</a></span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">number</span><span class="hspace">&nbsp;</span><span class="RktSym">query</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote><p>Continuations let us implement a <span class="RktSym">send/suspend</span> operation that
performs exactly that operation. The <span class="RktSym">send/suspend</span> procedure
generates a URL that represents the current connection&rsquo;s computation,
capturing it as a continuation. It passes the generated URL to a
procedure that creates the query page; this query page is used as the
result of the current connection, and the surrounding computation
(i.e., the continuation) is aborted. Finally, <span class="RktSym">send/suspend</span>
arranges for a request to the generated URL (in a new connection) to
restore the aborted computation.</p><p>Thus, <span class="RktSym">get-number</span> is implemented as follows:</p><blockquote class="SCodeFlow"><table cellspacing="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="../reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="RktStxLink" pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">get-number</span><span class="hspace">&nbsp;</span><span class="RktSym">label</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="RktStxLink" pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktSym">query</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktCmt">;</span><span class="RktCmt">&nbsp;</span><span class="RktCmt">Generate a URL for the current computation:</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">send/suspend</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktCmt">;</span><span class="RktCmt">&nbsp;</span><span class="RktCmt">Receive the computation-as-URL here:</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/lambda.html#(form._((lib._racket/private/base..rkt)._lambda))" class="RktStxLink" pltdoc="x">lambda</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">k-url</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktCmt">;</span><span class="RktCmt">&nbsp;</span><span class="RktCmt">Generate the query-page result for this connection.</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktCmt">;</span><span class="RktCmt">&nbsp;</span><span class="RktCmt">Send the query result to the saved-computation URL:</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">build-request-page</span><span class="hspace">&nbsp;</span><span class="RktSym">label</span><span class="hspace">&nbsp;</span><span class="RktSym">k-url</span><span class="hspace">&nbsp;</span><span class="RktVal">""</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktCmt">;</span><span class="RktCmt">&nbsp;</span><span class="RktCmt">We arrive here later, in a new connection</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/generic-numbers.html#(def._((quote._~23~25kernel)._string-~3enumber))" class="RktValLink" pltdoc="x">string-&gt;number</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/pairs.html#(def._((quote._~23~25kernel)._cdr))" class="RktValLink" pltdoc="x">cdr</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/pairs.html#(def._((lib._racket/private/list..rkt)._assq))" class="RktValLink" pltdoc="x">assq</a></span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">number</span><span class="hspace">&nbsp;</span><span class="RktSym">query</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote><p>We still have to implement <span class="RktSym">send/suspend</span>. For that task, we
import a library of control operators:</p><blockquote class="SCodeFlow"><p><span class="RktPn">(</span><span class="RktSym"><a href="../reference/require.html#(form._((lib._racket/private/base..rkt)._require))" class="RktStxLink" pltdoc="x">require</a></span><span class="hspace">&nbsp;</span><span class="RktSym">racket/control</span><span class="RktPn">)</span></p></blockquote><p>Specifically, we need <span class="RktSym"><a href="../reference/cont.html#(form._((lib._racket/control..rkt)._prompt))" class="RktStxLink" pltdoc="x">prompt</a></span> and <span class="RktSym"><a href="../reference/cont.html#(def._((lib._racket/control..rkt)._abort))" class="RktValLink" pltdoc="x">abort</a></span> from
<a href="../reference/cont.html#(mod-path._racket/control)" class="RktModLink" pltdoc="x"><span class="RktSym">racket/control</span></a>. We use <span class="RktSym"><a href="../reference/cont.html#(form._((lib._racket/control..rkt)._prompt))" class="RktStxLink" pltdoc="x">prompt</a></span> to mark the
place where a servlet is started, so that we can abort a computation
to that point. Change <span class="RktSym">handle</span> by wrapping an <span class="RktSym"><a href="../reference/cont.html#(form._((lib._racket/control..rkt)._prompt))" class="RktStxLink" pltdoc="x">prompt</a></span>
around the call to <span class="RktSym">dispatch</span>:</p><blockquote class="SCodeFlow"><table cellspacing="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="../reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="RktStxLink" pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">handle</span><span class="hspace">&nbsp;</span><span class="RktSym">in</span><span class="hspace">&nbsp;</span><span class="RktSym">out</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktSym">....</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/let.html#(form._((lib._racket/private/letstx-scheme..rkt)._let))" class="RktStxLink" pltdoc="x">let</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktPn">[</span><span class="RktSym">xexpr</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/cont.html#(form._((lib._racket/control..rkt)._prompt))" class="RktStxLink" pltdoc="x">prompt</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">dispatch</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/pairs.html#(def._((quote._~23~25kernel)._list-ref))" class="RktValLink" pltdoc="x">list-ref</a></span><span class="hspace">&nbsp;</span><span class="RktSym">req</span><span class="hspace">&nbsp;</span><span class="RktVal">1</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">]</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktSym">....</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote><p>Now, we can implement <span class="RktSym">send/suspend</span>. We use <span class="RktSym"><a href="../reference/cont.html#(def._((quote._~23~25kernel)._call/cc))" class="RktValLink" pltdoc="x">call/cc</a></span>
in the guise of <span class="RktSym"><a href="../reference/cont.html#(form._((lib._racket/private/more-scheme..rkt)._let/cc))" class="RktStxLink" pltdoc="x">let/cc</a></span>, which captures the current
computation up to an enclosing <span class="RktSym"><a href="../reference/cont.html#(form._((lib._racket/control..rkt)._prompt))" class="RktStxLink" pltdoc="x">prompt</a></span> and binds that
computation to an identifier&#8212;<wbr></wbr><span class="RktSym">k</span>, in this case:</p><blockquote class="SCodeFlow"><table cellspacing="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="../reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="RktStxLink" pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">send/suspend</span><span class="hspace">&nbsp;</span><span class="RktSym">mk-page</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/cont.html#(form._((lib._racket/private/more-scheme..rkt)._let/cc))" class="RktStxLink" pltdoc="x">let/cc</a></span><span class="hspace">&nbsp;</span><span class="RktSym">k</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktSym"><a href="../reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="RktStxLink" pltdoc="x">...</a></span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote><p>Next, we generate a new dispatch tag, and we record the mapping from
the tag to <span class="RktSym">k</span>:</p><blockquote class="SCodeFlow"><table cellspacing="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="../reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="RktStxLink" pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">send/suspend</span><span class="hspace">&nbsp;</span><span class="RktSym">mk-page</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/cont.html#(form._((lib._racket/private/more-scheme..rkt)._let/cc))" class="RktStxLink" pltdoc="x">let/cc</a></span><span class="hspace">&nbsp;</span><span class="RktSym">k</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="RktStxLink" pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="../reference/creatingunits.html#(form._((lib._mzlib/unit..rkt)._tag))" class="RktStxLink" pltdoc="x">tag</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/Writing.html#(def._((quote._~23~25kernel)._format))" class="RktValLink" pltdoc="x">format</a></span><span class="hspace">&nbsp;</span><span class="RktVal">"k~a"</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/time.html#(def._((quote._~23~25kernel)._current-inexact-milliseconds))" class="RktValLink" pltdoc="x">current-inexact-milliseconds</a></span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/hashtables.html#(def._((quote._~23~25kernel)._hash-set!))" class="RktValLink" pltdoc="x">hash-set!</a></span><span class="hspace">&nbsp;</span><span class="RktSym">dispatch-table</span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="../reference/creatingunits.html#(form._((lib._mzlib/unit..rkt)._tag))" class="RktStxLink" pltdoc="x">tag</a></span><span class="hspace">&nbsp;</span><span class="RktSym">k</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktSym"><a href="../reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="RktStxLink" pltdoc="x">...</a></span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote><p>Finally, we abort the current computation, supplying instead the page
that is built by applying the given <span class="RktSym">mk-page</span> to a URL for the
generated tag:</p><blockquote class="SCodeFlow"><table cellspacing="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="../reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="RktStxLink" pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">send/suspend</span><span class="hspace">&nbsp;</span><span class="RktSym">mk-page</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/cont.html#(form._((lib._racket/private/more-scheme..rkt)._let/cc))" class="RktStxLink" pltdoc="x">let/cc</a></span><span class="hspace">&nbsp;</span><span class="RktSym">k</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="RktStxLink" pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="../reference/creatingunits.html#(form._((lib._mzlib/unit..rkt)._tag))" class="RktStxLink" pltdoc="x">tag</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/Writing.html#(def._((quote._~23~25kernel)._format))" class="RktValLink" pltdoc="x">format</a></span><span class="hspace">&nbsp;</span><span class="RktVal">"k~a"</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/time.html#(def._((quote._~23~25kernel)._current-inexact-milliseconds))" class="RktValLink" pltdoc="x">current-inexact-milliseconds</a></span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/hashtables.html#(def._((quote._~23~25kernel)._hash-set!))" class="RktValLink" pltdoc="x">hash-set!</a></span><span class="hspace">&nbsp;</span><span class="RktSym">dispatch-table</span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="../reference/creatingunits.html#(form._((lib._mzlib/unit..rkt)._tag))" class="RktStxLink" pltdoc="x">tag</a></span><span class="hspace">&nbsp;</span><span class="RktSym">k</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/cont.html#(def._((lib._racket/control..rkt)._abort))" class="RktValLink" pltdoc="x">abort</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">mk-page</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/strings.html#(def._((quote._~23~25kernel)._string-append))" class="RktValLink" pltdoc="x">string-append</a></span><span class="hspace">&nbsp;</span><span class="RktVal">"/"</span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="../reference/creatingunits.html#(form._((lib._mzlib/unit..rkt)._tag))" class="RktStxLink" pltdoc="x">tag</a></span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote><p>When the user submits the form, the handler associated with the form&rsquo;s
URL is the old computation, stored as a continuation in the dispatch
table. Calling the continuation (like a function) restores the old
computation, passing the <span class="RktSym">query</span> argument back to that
computation.</p><blockquote class="refpara"><blockquote class="refcolumn"><blockquote class="refcontent"><p>Here&rsquo;s the final program in plain text: <a href="step9.txt">step 9</a>.</p></blockquote></blockquote></blockquote><p>In summary, the new pieces are: <span class="RktPn">(</span><span class="RktSym"><a href="../reference/require.html#(form._((lib._racket/private/base..rkt)._require))" class="RktStxLink" pltdoc="x">require</a></span><span class="stt"> </span><span class="RktSym">racket/control</span><span class="RktPn">)</span>,
adding <span class="RktSym"><a href="../reference/cont.html#(form._((lib._racket/control..rkt)._prompt))" class="RktStxLink" pltdoc="x">prompt</a></span> inside <span class="RktSym">handle</span>, the definitions of
<span class="RktSym">send/suspend</span>, <span class="RktSym">get-number</span>, and <span class="RktSym">sum2</span>, and
<span class="RktPn">(</span><span class="RktSym"><a href="../reference/hashtables.html#(def._((quote._~23~25kernel)._hash-set!))" class="RktValLink" pltdoc="x">hash-set!</a></span><span class="stt"> </span><span class="RktSym">dispatch-table</span><span class="stt"> </span><span class="RktVal">"sum2"</span><span class="stt"> </span><span class="RktSym">sum2</span><span class="RktPn">)</span>. Once you have
the server updated, visit <span class="stt">http://localhost:8081/sum2</span>.</p><h3>12<tt>&nbsp;</tt><a name="(part._.Where_to_.Go_.From_.Here)"></a>Where to Go From Here</h3><p>The Racket distribution includes a production-quality web server
that addresses all of the design points mentioned here and more.
To learn more, see the tutorial <a href="../continue/index.html" pltdoc="x">Continue: Web Applications in Racket</a>, the
documentation <a href="../web-server/index.html" pltdoc="x">Web Applications in Racket</a>, or the research paper
[<a href="#(cite._.Krishnamurthi07)" pltdoc="x">Krishnamurthi07</a>].</p><p>Otherwise, if you arrived here as part of an introduction to
Racket, then your next stop is probably <a href="../guide/index.html" pltdoc="x"><span style="font-weight: bold">The Racket Guide</span></a>.</p><p>If the topics covered here are the kind that interest you, see also
<a href="../reference/concurrency.html" pltdoc="x">Concurrency and Parallelism</a> and <a href="../reference/security.html" pltdoc="x">Reflection and Security</a> in <a href="../reference/index.html" pltdoc="x"><span style="font-weight: bold">The Racket Reference</span></a>.</p><p>Some of this material is based on relatively recent research, and more
information can be found in papers written by the authors of Racket,
including papers on GRacket (formerly &ldquo;MrEd&rdquo;) [<a href="#(cite._.Flatt99)" pltdoc="x">Flatt99</a>],
memory accounting [<a href="#(cite._.Wick04)" pltdoc="x">Wick04</a>], kill-safe abstractions
[<a href="#(cite._.Flatt04)" pltdoc="x">Flatt04</a>], and delimited continuations [<a href="#(cite._.Flatt07)" pltdoc="x">Flatt07</a>].</p><h3><a name="(part._doc-bibliography)"></a>Bibliography</h3><p><table cellspacing="0" class="RBibliography"><tr><td><a name="(cite._.Flatt99)"></a>[Flatt99]</td><td><span class="hspace">&nbsp;</span></td><td><span class="bibentry">Matthew Flatt, Robert Bruce Findler, Shriram Krishnamurthi, and Matthias Felleisen, &ldquo;Programming Languages as Operating Systems
(<span style="font-style: italic">or</span> Revenge of the Son of the Lisp Machine),&rdquo; International Conference on Functional Programming, 1999. <a href="http://www.ccs.neu.edu/scheme/pubs/icfp99-ffkf.pdf"><span class="stt">http://www.ccs.neu.edu/scheme/pubs/icfp99-ffkf.pdf</span></a></span></td></tr><tr><td><a name="(cite._.Flatt04)"></a>[Flatt04]</td><td><span class="hspace">&nbsp;</span></td><td><span class="bibentry">Matthew Flatt and Robert Bruce Findler, &ldquo;Kill-Safe Synchronization Abstractions,&rdquo; Programming Language Design and Implementation, 2004. <a href="http://www.cs.utah.edu/plt/publications/pldi04-ff.pdf"><span class="stt">http://www.cs.utah.edu/plt/publications/pldi04-ff.pdf</span></a></span></td></tr><tr><td><a name="(cite._.Flatt07)"></a>[Flatt07]</td><td><span class="hspace">&nbsp;</span></td><td><span class="bibentry">Matthew Flatt, Gang Yu, Robert Bruce Findler, and Matthias Felleisen, &ldquo;Adding Delimited and Composable Control to a Production Programming Environment,&rdquo; International Conference on Functional Programming, 2007. <a href="http://www.cs.utah.edu/plt/publications/icfp07-fyff.pdf"><span class="stt">http://www.cs.utah.edu/plt/publications/icfp07-fyff.pdf</span></a></span></td></tr><tr><td><a name="(cite._.Krishnamurthi07)"></a>[Krishnamurthi07]</td><td><span class="hspace">&nbsp;</span></td><td><span class="bibentry">Shriram Krishnamurthi, Peter Hopkins, Jay McCarthy, Paul T. Graunke, Greg Pettyjohn, and Matthias Felleisen, &ldquo;Implementation and Use of the PLT Scheme Web Server,&rdquo; <span style="font-style: italic">Higher-Order and Symbolic Computation</span>, 2007. <a href="http://www.cs.brown.edu/~sk/Publications/Papers/Published/khmgpf-impl-use-plt-web-server-journal/paper.pdf"><span class="stt">http://www.cs.brown.edu/~sk/Publications/Papers/Published/khmgpf-impl-use-plt-web-server-journal/paper.pdf</span></a></span></td></tr><tr><td><a name="(cite._.Queinnec00)"></a>[Queinnec00]</td><td><span class="hspace">&nbsp;</span></td><td><span class="bibentry">Christian Queinnec, &ldquo;The Influence of Browsers on Evaluators or, Continuations to Program Web Servers,&rdquo; International Conference on Functional Programming, 2000. <a href="http://www-spi.lip6.fr/~queinnec/Papers/webcont.ps.gz"><span class="stt">http://www-spi.lip6.fr/~queinnec/Papers/webcont.ps.gz</span></a></span></td></tr><tr><td><a name="(cite._.Wick04)"></a>[Wick04]</td><td><span class="hspace">&nbsp;</span></td><td><span class="bibentry">Adam Wick and Matthew Flatt, &ldquo;Memory Accounting without Partitions,&rdquo; International Symposium on Memory Management, 2004. <a href="http://www.cs.utah.edu/plt/publications/ismm04-wf.pdf"><span class="stt">http://www.cs.utah.edu/plt/publications/ismm04-wf.pdf</span></a></span></td></tr></table></p><div class="navsetbottom"><span class="navleft"><form class="searchform"><input class="searchbox" style="color: #888;" type="text" value="...search manuals..." title="Enter a search string to search the manuals" onkeypress="return DoSearchKey(event, this, &quot;5.2.1&quot;, &quot;../&quot;);" onfocus="this.style.color=&quot;black&quot;; this.style.textAlign=&quot;left&quot;; if (this.value == &quot;...search manuals...&quot;) this.value=&quot;&quot;;" onblur="if (this.value.match(/^ *$/)) { this.style.color=&quot;#888&quot;; this.style.textAlign=&quot;center&quot;; this.value=&quot;...search manuals...&quot;; }" /></form>&nbsp;&nbsp;<a href="../index.html" title="up to the documentation top" pltdoc="x" onclick="return GotoPLTRoot(&quot;5.2.1&quot;);">top</a></span><span class="navright"><span class="nonavigation">&larr; prev</span>&nbsp;&nbsp;<a href="../index.html" title="up to the documentation top" pltdoc="x" onclick="return GotoPLTRoot(&quot;5.2.1&quot;);">up</a>&nbsp;&nbsp;<span class="nonavigation">next &rarr;</span></span>&nbsp;</div></div></div><div id="contextindicator">&nbsp;</div></body></html>